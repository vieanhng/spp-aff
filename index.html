<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopee Affiliate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: { preflight: true },
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #ffffff;
            color: #111827;
        }

        .transition-all {
            transition: all 0.2s ease;
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-6 max-w-2xl mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-xl font-semibold tracking-tight">Tạo Link Tiếp Thị Shopee</h1>
    </div>

    <div class="space-y-5">
        <!-- Product URL -->
        <div>
            <label for="productUrl" class="block text-xs font-medium text-gray-700 mb-1">Link sản phẩm Shopee</label>
            <input type="url" id="productUrl" placeholder="https://shopee.vn/product/..."
                class="w-full px-3 py-2.5 text-base md:text-sm border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-black" />
        </div>

        <!-- Affiliate ID Collapsible -->
        <div>
            <button id="toggleAffiliate" class="block w-full text-left text-xs font-medium text-gray-700 mb-1">
                Affiliate ID
            </button>
            <div id="affiliateInput" class="hidden mt-1">
                <input type="text" id="affiliateId" value="17310100001"
                    class="w-full px-3 py-2.5 text-base md:text-sm font-mono border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-black" />
            </div>
        </div>

        <!-- Buttons -->
        <div class="flex gap-2 pt-2">
            <button id="generateBtn"
                class="flex-1 py-2.5 text-sm font-medium bg-black text-white rounded hover:bg-gray-800 transition-all">
                Tạo link
            </button>
            <button id="resetBtn"
                class="px-4 py-2.5 text-sm font-medium text-gray-600 border border-gray-200 rounded hover:bg-gray-50 transition-all">
                Xóa
            </button>
        </div>
    </div>

    <!-- Product Info (Dynamic) -->
    <div id="productInfo" class="hidden mt-6 p-4 border border-gray-100 rounded-lg bg-gray-50 flex gap-4">
        <img id="productImage" src="" alt="Product" class="w-20 h-20 object-cover rounded border border-gray-200" />
        <div class="flex-1 min-w-0">
            <h3 id="productName" class="text-sm font-medium text-gray-900 truncate-2-lines line-clamp-2 mb-1"></h3>
            <div class="flex items-center gap-2">
                <span id="productPrice" class="text-sm font-semibold text-red-600"></span>
                <span id="productCommission"
                    class="text-xs text-green-600 font-medium bg-green-50 px-1.5 py-0.5 rounded"></span>
            </div>
        </div>
    </div>

    <!-- Result -->
    <div id="resultSection" class="hidden mt-4">
        <div class="mb-3">
            <input type="text" id="resultLink" readonly
                class="w-full px-3 py-2.5 text-base md:text-sm font-mono bg-gray-50 border border-gray-200 rounded" />
        </div>
        <div class="flex gap-2">
            <button id="copyBtn"
                class="flex-1 py-2.5 text-sm font-medium border border-gray-300 rounded hover:bg-gray-50 transition-all">
                Sao chép
            </button>
            <button id="visitBtn"
                class="flex-1 py-2.5 text-sm font-medium bg-black text-white rounded hover:bg-gray-800 transition-all">
                Truy cập
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productUrlInput = document.getElementById('productUrl');
            const affiliateIdInput = document.getElementById('affiliateId');
            const toggleBtn = document.getElementById('toggleAffiliate');
            const affiliateInput = document.getElementById('affiliateInput');
            const generateBtn = document.getElementById('generateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const resultSection = document.getElementById('resultSection');
            const resultLink = document.getElementById('resultLink');
            const copyBtn = document.getElementById('copyBtn');
            const visitBtn = document.getElementById('visitBtn');

            const productInfo = document.getElementById('productInfo');
            const productImage = document.getElementById('productImage');
            const productName = document.getElementById('productName');
            const productPrice = document.getElementById('productPrice');
            const productCommission = document.getElementById('productCommission');

            let isOpen = false;
            toggleBtn.addEventListener('click', () => {
                isOpen = !isOpen;
                affiliateInput.classList.toggle('hidden');
                toggleBtn.textContent = isOpen ? 'Affiliate ID ▼' : 'Affiliate ID';
            });

            generateBtn.addEventListener('click', async () => {
                const url = productUrlInput.value.trim();
                const affId = affiliateIdInput.value.trim() || '17310100001';

                if (!url) {
                    alert('Vui lòng nhập link sản phẩm Shopee.');
                    return;
                }

                const valid = ['shopee.vn', 'shopee.sg', 'shopee.co.id', 'shopee.ph', 'shopee.th', 'shopee.com.my', 's.shopee.vn'];
                if (!valid.some(d => url.includes(d))) {
                    alert('Link phải từ Shopee (shopee.vn, shopee.sg, v.v.)');
                    return;
                }

                const originalBtnText = generateBtn.textContent;
                generateBtn.textContent = 'Đang xử lý...';
                generateBtn.disabled = true;

                try {
                    const response = await fetch("https://api.tui3gang.com/api/v1/shopee/get-info-product", {
                        "headers": {
                            "accept": "application/json, text/plain, */*",
                            "content-type": "application/json",
                        },
                        "body": JSON.stringify({
                            "url": url,
                            "idUser": "notlogin"
                        }),
                        "method": "POST",
                    });

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const data = await response.json();

                    if (data && data.length > 0 && data[0].productLink) {
                        const product = data[0];
                        const productLink = product.productLink;
                        const encoded = encodeURIComponent(productLink);

                        // Populate product info
                        productImage.src = product.imageUrl;
                        productName.textContent = product.productName;
                        productPrice.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.priceMin);

                        if (product.commission > 0) {
                            productCommission.textContent = `Hoa hồng: +${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.commission / 0.6)}`;
                            productCommission.classList.remove('hidden');
                        } else {
                            productCommission.classList.add('hidden');
                        }

                        productInfo.classList.remove('hidden');

                        resultLink.value = `https://shope.ee/an_redir?origin_link=${encoded}&affiliate_id=${affId}&sub_id=webgenerate`;
                        resultSection.classList.remove('hidden');
                        productInfo.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        alert('Không tìm thấy thông tin sản phẩm. Vui lòng kiểm tra lại link.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi lấy thông tin sản phẩm. Vui lòng thử lại sau.');
                } finally {
                    generateBtn.textContent = originalBtnText;
                    generateBtn.disabled = false;
                }
            });

            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(resultLink.value).then(() => {
                    const original = copyBtn.textContent;
                    copyBtn.textContent = 'Đã sao chép!';
                    setTimeout(() => copyBtn.textContent = original, 1500);
                });
            });

            visitBtn.addEventListener('click', () => {
                const link = resultLink.value;
                if (!link) return;

                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
                if (isMobile) {
                    const encodedLink = encodeURIComponent(link);
                    // Dựa theo guide: shopeevn://reactPath?smtt=9&path=shopee%2FTRANSFER_PAGE&navigate_url="[URL đã được mã hóa]"&tab=buy"utm_source=[theo dõi 1]&utm_medium=[theo dõi 2]&utm_campaign=[theo dõi 3]&utm_content=[theo dõi 4]
                    const deepLink = `shopeevn://reactPath?smtt=9&path=shopee%2FTRANSFER_PAGE&navigate_url=${encodedLink}&tab=buy&utm_source=affiliate&utm_medium=deeplink&utm_campaign=webgenerate`;
                    window.location.href = deepLink;
                } else {
                    window.open(link, '_blank', 'noopener,noreferrer');
                }
            });

            resetBtn.addEventListener('click', () => {
                productUrlInput.value = '';
                resultSection.classList.add('hidden');
                productInfo.classList.add('hidden');
            });
        });
    </script>
</body>

</html>